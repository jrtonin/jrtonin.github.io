---
title: "Essay II: What happened to the Brazilian airline market during the pandemic?"
author: "Jo√£o Ricardo Tonin"
date: 2021-11-15T17:42:34-03:00
draft: false
output:
  md_document:
    variant: markdown
    preserve_yaml: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# define memory limit
memory.limit(size = 999999999999)

{ 
  # Check if the packages that we need are installed
  want = c("tidyverse", "plm", "texreg", "lmtest", "tibble",
           "gluedown", "stringr", "rvest", "kableExtra", "broom")
  have = want %in% rownames(installed.packages())
  # Install the packages that we miss
  if ( any(!have) ) { install.packages( want[!have] ) }
  # Load the packages
  junk <- lapply(want, library, character.only = T)
  # Remove the objects we created
  rm(have, want, junk)
} # Import packages

```

```{r reading_databases, include=FALSE, echo=TRUE}

# reading log databases
LBASE1 = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/LBASE1_Essay_II.rds"))
LBASE1c = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/LBASE1c_Essay_II.rds"))
LBASE2 = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/LBASE2_Essay_II.rds"))
LBASE2c = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/LBASE2c_Essay_II.rds"))

# read normal databases
BASE1 = readRDS(url("https://github.com/jrtonin/thesis_data/raw/main/data/final/BASE1_Essay_II.rds"))
BASE2 = readRDS(url("https://github.com/jrtonin/thesis_data/raw/main/data/final/BASE2_Essay_II.rds"))

```

#### I - What is the Brazillian airline market estructure?

```{r airline_market, include=TRUE, echo=FALSE}

# summarizing number of routes
nroutes = BASE1 %>%
  group_by(air_dep, air_arr, covid_wave) %>%
  dplyr::summarise(n = n()) %>%
  group_by(covid_wave) %>%
  dplyr::summarise(n = n()) %>%
  spread(covid_wave, n) %>%
  mutate(variable = "Number of routes") %>%
  select(variable, normal, first, second)

# summarizing number of competitors
ncompetitors = BASE1 %>%
  group_by(covid_wave, airline) %>%
  dplyr::summarise(n = n()) %>%
  group_by(covid_wave) %>%
  dplyr::summarise(n = n()) %>%
  spread(covid_wave, n) %>%
  mutate(variable = "Number of competitors") %>%
  select(variable, normal, first, second)

# calculating passengers and takeoffs monthly realized
nmarket = BASE1 %>%
  group_by(covid_wave, year, month) %>%
  dplyr::summarise(seat_dem = sum(seat_com),
                   take_off = sum(take_off),
                   seat_offer = sum(seat_offer)) %>%
  group_by(covid_wave) %>%
  dplyr::summarise(seat_dem = sum(seat_dem),
                   take_off = sum(take_off),
                   seat_offer = sum(seat_offer),
                   n = n()) %>%
  mutate(aircraft = round(seat_offer/take_off, 0),
         seat_dem = round((seat_dem/n)/1000000, 0),
         take_off = round((take_off/n)/1000, 0),
         seat_offer = round((seat_offer/n)/1000000, 0),
         seat_ocupation = round(seat_dem/seat_offer, 2)*100) %>%
  select(seat_dem, take_off, aircraft, seat_ocupation, covid_wave) %>%
  gather(variable, n, seat_dem:seat_ocupation) %>%
  spread(covid_wave, n) %>%
  mutate(id = case_when(variable == "seat_dem" ~ 1,
                        variable == "seat_ocupation" ~ 2,
                        variable == "take_off" ~ 3, 
                        variable == "aircraft" ~ 4)) %>%
  arrange(id) %>%
  select(variable, normal, first, second)

# merging final database
final = nroutes %>% bind_rows(ncompetitors, nmarket) %>%
  mutate(variable = case_when(variable == "aircraft" ~ "Aircraft size (number of seats)",
                              variable == "seat_dem" ~ "Monthly seats sold average (in millions)",
                              variable == "seat_ocupation" ~ "Aircraft seats occupation average (in %)",
                              variable == "take_off" ~ "Monthly takeoff average (in thousand)",
                              TRUE ~ variable))
  
# printing final database
kable(head(final))

```

Main results found:

 * The number of routes and aircraft occupancy rate showed a downward trend during the two pandemic periods;
 
 * Three companies stopped operating during the pandemic;
 
 * The number of seats sold monthly dropped 61.68% during the first Covid19 period and recovered 12.3% in the second moment;
 
 * The average aircraft size increased in the first Covid19 period and decreased again in the second wave, but remained higher than in the period before the pandemic.


#### II - How is the Brazilian commercial aviation market competition?

```{r airline_competition, include=TRUE, echo=FALSE}

# calculation number of routes by type of market
nroutes = BASE1 %>%
  mutate(competition = case_when(N == 1 ~ "single",
                                 N == 2 ~ "duopoly",
                                 TRUE ~ "oligopoly")) %>%
  group_by(competition, air_dep, air_arr, covid_wave) %>%
  dplyr::summarise(n = n()) %>%
  group_by(competition, covid_wave) %>%
  dplyr::summarise(n = n()) %>%
  spread(competition, n) %>%
  mutate(id = case_when(covid_wave == "normal" ~ 1,
                        covid_wave == "first" ~ 2, 
                        TRUE ~ 3)) %>%
  arrange(id) %>%
  select(covid_wave, single, duopoly, oligopoly) %>%
  mutate(total = single + duopoly + oligopoly) %>%
  mutate(var_1 =  round((single/(dplyr::lag(single))-1)*100, 2),
         var_2 =  round((duopoly/(dplyr::lag(duopoly))-1)*100, 2),
         var_3 =  round((oligopoly/(dplyr::lag(oligopoly))-1)*100, 2),
         var_4 =  round((total/(dplyr::lag(total))-1)*100, 2)) %>%
  select(covid_wave, single, var_1, duopoly, var_2, oligopoly, var_3, total, var_4) %>%
  mutate(across(everything(), ~ replace_na(., 0)),
         variable = "Number of routes")  

# calculation share of seats sold by type of market
nseats = BASE1 %>%
  mutate(competition = case_when(N == 1 ~ "single",
                                 N == 2 ~ "duopoly",
                                 TRUE ~ "oligopoly")) %>%
  select(seat_com, competition, covid_wave) %>%
  group_by(competition, covid_wave) %>%
  summarise(seatsold = sum(seat_com)) %>%
  spread(competition, seatsold) %>%
  mutate(id = case_when(covid_wave == "normal" ~ 1,
                        covid_wave == "first" ~ 2, 
                        TRUE ~ 3)) %>%
  arrange(id) %>%
  select(covid_wave, single, duopoly, oligopoly) %>%
  mutate(total = single + duopoly + oligopoly) %>%
  mutate(single = round((single/total)*100, 2),
         duopoly = round((duopoly/total)*100, 2),
         oligopoly = round((oligopoly/total)*100, 2),
         total = single + duopoly + oligopoly) %>%
  mutate(var_1 =  round((single - (dplyr::lag(single))), 2),
         var_2 =  round((duopoly - (dplyr::lag(duopoly))), 2),
         var_3 =  round((oligopoly - (dplyr::lag(oligopoly))), 2),
         var_4 =  round((total - (dplyr::lag(total))), 2)) %>%
  select(covid_wave, single, var_1, duopoly, var_2, oligopoly, var_3, total, var_4) %>%
  mutate(across(everything(), ~ replace_na(., 0)),
         variable = "seats sold (share %)")
  
# calculation share of takeoff performed by type of market
ntakeoff = BASE1 %>%
  mutate(competition = case_when(N == 1 ~ "single",
                                 N == 2 ~ "duopoly",
                                 TRUE ~ "oligopoly")) %>%
  select(take_off, competition, covid_wave) %>%
  group_by(competition, covid_wave) %>%
  summarise(take_off = sum(take_off)) %>%
  spread(competition, take_off) %>%
  mutate(id = case_when(covid_wave == "normal" ~ 1,
                        covid_wave == "first" ~ 2, 
                        TRUE ~ 3)) %>%
  arrange(id) %>%
  select(covid_wave, single, duopoly, oligopoly) %>%
  mutate(total = single + duopoly + oligopoly) %>%
  mutate(single = round((single/total)*100, 2),
         duopoly = round((duopoly/total)*100, 2),
         oligopoly = round((oligopoly/total)*100, 2),
         total = 100) %>%
  mutate(var_1 =  round((single - (dplyr::lag(single))), 2),
         var_2 =  round((duopoly - (dplyr::lag(duopoly))), 2),
         var_3 =  round((oligopoly - (dplyr::lag(oligopoly))), 2),
         var_4 =  round((total - (dplyr::lag(total))), 2)) %>%
  select(covid_wave, single, var_1, duopoly, var_2, oligopoly, var_3, total, var_4) %>%
  mutate(across(everything(), ~ replace_na(., 0)),
         variable = "Takeoffs (share %)") 

# calculation average distance by type of market
ndistance = BASE1 %>%
  mutate(competition = case_when(N == 1 ~ "single",
                                 N == 2 ~ "duopoly",
                                 TRUE ~ "oligopoly")) %>%
  group_by(competition, air_dep, air_arr, covid_wave) %>%
  dplyr::summarise(n = n(), 
                   distance = sum(distance)) %>%
  group_by(competition, covid_wave) %>%
  dplyr::summarise(n = sum(n),
                   distance = sum(distance)) %>% 
  bind_rows(BASE1 %>% ungroup() %>%
              group_by(covid_wave) %>%
              dplyr::summarise(n = n(),
                               distance = sum(distance),
                               competition = "total")) %>%
  mutate(distance = round(distance/n, 0)) %>%
  select(-n) %>%
  spread(competition, distance) %>%
  mutate(id = case_when(covid_wave == "normal" ~ 1,
                        covid_wave == "first" ~ 2, 
                        TRUE ~ 3)) %>%
  arrange(id) %>%
  select(covid_wave, single, duopoly, oligopoly, total) %>%
  mutate(var_1 =  round((single/(dplyr::lag(single))-1)*100, 2),
         var_2 =  round((duopoly/(dplyr::lag(duopoly))-1)*100, 2),
         var_3 =  round((oligopoly/(dplyr::lag(oligopoly))-1)*100, 2),
         var_4 =  round((total/(dplyr::lag(total))-1)*100, 2)) %>%
  select(covid_wave, single, var_1, duopoly, var_2, oligopoly, var_3, total, var_4) %>%
  mutate(across(everything(), ~ replace_na(., 0)),
         variable = "Average distance") 

# calculation average prices by type of market
nprices = BASE1 %>%
  mutate(competition = case_when(N == 1 ~ "single",
                                 N == 2 ~ "duopoly",
                                 TRUE ~ "oligopoly")) %>%
  group_by(competition, covid_wave) %>%
  dplyr::summarise(seats = sum(seat_dem), 
                   revenue = sum(revenue)) %>% 
  bind_rows(BASE1 %>% ungroup() %>%
              group_by(covid_wave) %>%
              dplyr::summarise(seats = sum(seat_dem),
                               revenue = sum(revenue),
                               competition = "total")) %>%
  mutate(prices = round(revenue/seats, 0)) %>%
  select(-revenue, -seats) %>%
  spread(competition, prices) %>%
  mutate(id = case_when(covid_wave == "normal" ~ 1,
                        covid_wave == "first" ~ 2, 
                        TRUE ~ 3)) %>%
  arrange(id) %>%
  select(covid_wave, single, duopoly, oligopoly, total) %>%
  mutate(var_1 =  round((single/(dplyr::lag(single))-1)*100, 2),
         var_2 =  round((duopoly/(dplyr::lag(duopoly))-1)*100, 2),
         var_3 =  round((oligopoly/(dplyr::lag(oligopoly))-1)*100, 2),
         var_4 =  round((total/(dplyr::lag(total))-1)*100, 2)) %>%
  select(covid_wave, single, var_1, duopoly, var_2, oligopoly, var_3, total, var_4) %>%
  mutate(across(everything(), ~ replace_na(., 0)),
         variable = "Average prices") 

# editing final database
dcompetition = nroutes %>%
  bind_rows(nprices, nseats, ntakeoff, ndistance) %>%
  mutate(across(c(single, duopoly, oligopoly), as.double)) %>%
  select(variable, covid_wave, single, var_1, duopoly, var_2, oligopoly, var_3, total, var_4) %>%
  mutate(across(c(single, var_1, duopoly, var_2, oligopoly, var_3, total, var_4), ~ round(.x, 1)))

# printing final database
kable(head(dcompetition, n = 15L)) 

```

Main results found:

 * The number of routes served by Brazilian commercial aviation decreased during the pandemic period, mainly in oligopolistic markets;
 
 * Fares fell in Covid19's first phase, but returned to a level higher than pre-pandemic in the second phase;
 
 * In the first stage of Covid19, the number of companies operating on the same route decreased causing the oligopolized routes to become duopoly or monopoly, in the second stage the monopolies continued to grow while part of the duopolies became oligopolies;
 
 * During the pandemic, routes with only one company operating had an increase in average distance, while oligopolist routes has the opposite effect.


#### III - How did Brazilian commercial aviation behave regionally in the pandemic?

```{r regional, include=TRUE, echo=FALSE}

# organizing arrival database
darrival = BASE1 %>%
  mutate(region_arr = case_when(air_arr == "SBTC" ~ "Nordeste", TRUE ~ region_arr),
         region_dep = case_when(air_dep == "SBTC" ~ "Nordeste", TRUE ~ region_dep)) %>%
  group_by(air_dep, air_arr, covid_wave, region_arr) %>%
  dplyr::summarise(n = n(),
                   seats = sum(seat_com)) %>%
  mutate(region_arr = case_when(region_arr == "Nordeste" ~ "a_NE",
                                region_arr == "Centro Oeste" ~ "a_MW",
                                region_arr == "Sul" ~ "a_S",
                                region_arr == "Sudeste" ~ "a_SE",
                                region_arr == "Norte" ~ "a_N", TRUE ~ "ERROR")) %>%
  group_by(covid_wave, region_arr) %>%
  dplyr::summarise(routes = n(),
                   seats = sum(seats)) %>%
  gather(variable, result, routes, seats) %>%
  spread(region_arr, result) %>%
  mutate(id = case_when(covid_wave == "normal" & variable == "routes" ~ 1, 
                        covid_wave == "normal" & variable == "seats" ~ 4,
                        covid_wave == "first" & variable == "routes" ~ 2,
                        covid_wave == "first" & variable == "seats" ~ 5,
                        covid_wave == "second" & variable == "routes" ~ 3,
                        covid_wave == "second" & variable == "seats" ~ 6,
                        TRUE ~ 7)) %>%
  arrange(id) %>%
  mutate(total = a_NE + a_MW + a_SE + a_S + a_N) %>%
  mutate(across(c(a_NE, a_MW, a_SE, a_S, a_N), ~ round((.x/total)*100, 2))) %>%
  select(-total, -id)

# organizing departure database
ddeparture = BASE1 %>%
  mutate(region_arr = case_when(air_arr == "SBTC" ~ "Nordeste", TRUE ~ region_arr),
         region_dep = case_when(air_dep == "SBTC" ~ "Nordeste", TRUE ~ region_dep)) %>%
  group_by(air_dep, air_arr, covid_wave, region_dep) %>%
  dplyr::summarise(n = n(),
                   seats = sum(seat_com)) %>%
  mutate(region_dep = case_when(region_dep == "Nordeste" ~ "d_NE",
                                region_dep == "Centro Oeste" ~ "d_MW",
                                region_dep == "Sul" ~ "d_S",
                                region_dep == "Sudeste" ~ "d_SE",
                                region_dep == "Norte" ~ "d_N", TRUE ~ "ERROR")) %>%
  group_by(covid_wave, region_dep) %>%
  dplyr::summarise(routes = n(),
                   seats = sum(seats)) %>%
  gather(variable, result, routes, seats) %>%
  spread(region_dep, result) %>%
  mutate(id = case_when(covid_wave == "normal" & variable == "routes" ~ 1, 
                        covid_wave == "normal" & variable == "seats" ~ 4,
                        covid_wave == "first" & variable == "routes" ~ 2,
                        covid_wave == "first" & variable == "seats" ~ 5,
                        covid_wave == "second" & variable == "routes" ~ 3,
                        covid_wave == "second" & variable == "seats" ~ 6,
                        TRUE ~ 7)) %>%
  arrange(id) %>%
  mutate(total = d_NE + d_MW + d_SE + d_S + d_N) %>%
  mutate(across(c(d_NE, d_MW, d_SE, d_S, d_N), ~ round((.x/total)*100, 2))) %>%
  select(-total, -id) 

# organizing final database
region = darrival %>%
  left_join(ddeparture, by = c("covid_wave", "variable"))

# printing final database
kable(head(region, n = 6L)) 

```

Main results found:

 * During a pandemic, airports in the North and Northeast regions increased their market share in terms of both the number of routes and the volume of tickets sold;
 
 * The Southeast region had an increase in share in departure routes while the South region was the most affected, lost share both in departure and arrival points.
 
#### V - Did the pandemic change passenger boarding times at Brazilian airports?

```{r schedulle, include=TRUE, echo=FALSE}

# organizing database
schedulle = BASE1 %>%
  select(covid_wave, `0-5`, `6-11`, `12-17`, `18-23`) %>%
  gather(schedulle, departure, `0-5`:`18-23`) %>%
  group_by(covid_wave, schedulle) %>%
  dplyr::summarise(departure = mean(departure)) %>%
  spread(schedulle, departure) %>%
  mutate(id = case_when(covid_wave == "normal" ~ 1,
                        covid_wave == "first" ~ 2, 
                        TRUE ~ 3)) %>%
  mutate(across(c(`0-5`, `6-11`, `12-17`, `18-23`), ~ round(.x*100, 2))) %>%
  arrange(id) %>%
  select(-id)

# printing final database
kable(head(schedulle, n = 3L))

```

Main results found:

 * 
 
 
```{r competitors_I, include=TRUE, echo=FALSE}

# organizing database
cprice = BASE1 %>%
  mutate(competition = case_when(N == 1 ~ "single",
                                 N == 2 ~ "duopoly",
                                 TRUE ~ "oligopoly")) %>%
  mutate(airline = case_when(airline == "AZU" ~ "AZU",
                                 airline == "GLO" ~ "GLO",
                                 airline == "TAM" ~ "TAM",
                                 TRUE ~ "OUT")) %>%
  group_by(airline, covid_wave, competition) %>%
  summarise(demand = sum(seat_dem),
            revenue = sum(revenue),
            take_off = sum(take_off),
            seat_offer = sum(seat_offer)) %>%
  bind_rows(BASE1 %>%
  mutate(airline = case_when(airline == "AZU" ~ "AZU",
                                 airline == "GLO" ~ "GLO",
                                 airline == "TAM" ~ "TAM",
                                 TRUE ~ "OUT")) %>%            
  mutate(competition = "total") %>%
  group_by(airline, covid_wave, competition) %>%
  summarise(demand = sum(seat_dem),
            revenue = sum(revenue),
            take_off = sum(take_off),
            seat_offer = sum(seat_offer))) %>%
  mutate(price = revenue/demand,
         aircraft = seat_offer/take_off) %>%
  select(airline, covid_wave, competition, take_off, price, aircraft, demand) %>%
  gather(variable, value, take_off:demand) %>%
  spread(competition, value) %>%
  mutate(across(c(duopoly, oligopoly, single, total),  as.double)) %>%
  mutate(duopoly = case_when(variable %in% c("demand", "take_off") ~ (duopoly/total)*100, TRUE ~ duopoly),
         oligopoly = case_when(variable %in% c("demand", "take_off") ~ (oligopoly/total)*100, 
                               TRUE ~ oligopoly),
         single = case_when(variable %in% c("demand", "take_off") ~ (single/total)*100, TRUE ~ single),
         total = case_when(variable %in% c("demand", "take_off") ~ (total/total)*100, TRUE ~ total)) %>%
  mutate(across(c(duopoly, oligopoly, single, total), ~ round(.x, 2))) %>%
  mutate(id = case_when(covid_wave == "normal" ~ 1,
                        covid_wave == "first" ~ 2, 
                        TRUE ~ 3)) %>%
  arrange(airline, id) %>%
  select(-id) %>%
  gather(market, value, duopoly:total) %>%
  mutate(market = case_when(market == "duopoly" ~ "b.duo", 
                            market == "oligopoly" ~ "c.oli", 
                            market == "single" ~ "a.sin", 
                            TRUE ~ "d.tot")) %>%
  mutate(id = paste0(airline,"-", market)) %>% ungroup() %>%
  select(-airline, -market) %>%
  spread(id, value) %>%
  mutate(id = case_when(covid_wave == "normal" ~ 1,
                        covid_wave == "first" ~ 2, 
                        TRUE ~ 3)) %>%
  arrange(variable, id) %>%
  select(-id)

# printing final database
kable(head(cprice, n = 12L))

```
 
Main results found:

 * 
 
```{r competitors_II, include=TRUE, echo=FALSE}

# organizing database
dcompetition = BASE1 %>%
  filter(N >= 2)  %>%
  mutate(position = market,
         market = case_when(N == 2 ~ "duopoly", TRUE ~ "oligopoly")) %>%
  mutate(airline = case_when(airline %in% c("GLO", "AZU", "TAM") ~ airline, TRUE ~ "OUT")) %>%
  mutate(position = case_when(position == "lider" ~ airline, TRUE ~ position)) %>%
  group_by(covid_wave, market, position) %>%
  dplyr::summarise(demand = sum(seat_dem),
                   revenue = sum(revenue),
                   take_off = sum(take_off),
                   seat_offer = sum(seat_offer))

# selecting routes that GLO was the leader competitor
GLO = BASE1 %>%
  filter(N >= 2) %>%
  mutate(code = paste0(month, "-", year, "-", air_dep, "-", air_arr)) %>%
  filter(market == "lider" & airline == "GLO") %>%
  group_by(code) %>%
  dplyr::summarise(n = n()) %>% 
  select(-n)

# generating GLO vector
GLO = as.vector(GLO$code) 

# filtering GLO vector into BASE1
GLOc = BASE1 %>%
  arrange(year, month, air_dep, air_arr) %>%
  mutate(code = paste0(month, "-", year, "-", air_dep, "-", air_arr)) %>%
  filter(code %in% GLO) %>% 
  mutate(position = market,
         market = case_when(N == 2 ~ "duopoly", TRUE ~ "oligopoly")) %>%
  group_by(covid_wave, market, position, code) %>%
  dplyr::summarise(demand = sum(seat_dem),
                   revenue = sum(revenue),
                   take_off = sum(take_off),
                   seat_offer = sum(seat_offer)) %>%
  mutate(price = revenue/demand, 
         aircraft = seat_offer/take_off) %>%
  select(-demand, -revenue, -take_off, -seat_offer) %>%
  gather(variable, value, price:aircraft) %>%
  spread(variable, value) %>%
  arrange(position, covid_wave, desc(market), code) %>%
  group_by(position, covid_wave, market) %>% 
  mutate(id = sequence(n()))





```





```{r sd_full, include=FALSE, echo=FALSE}

## organizing database

# applying mean operation
sdfulla = BASE1 %>% ungroup() %>%
  group_by(covid_wave) %>%
  summarise(across(c(price, hubling, aircraft, flight_hours, take_off, RouteShare, tx_seat, 
         free_luggage, paid_luggage, `0-5`, `6-11`, `12-17`, `18-23`, DepHUB,          
         capital_dep, ArrHUB, capital_arr), ~ mean(.x, na.rm = TRUE))) %>%
  mutate(covid_wave = case_when(covid_wave == "normal" ~ 1,
                                covid_wave == "first" ~ 3,
                                covid_wave == "second" ~ 5, TRUE ~ 0))

# applying sd operation
sdfullb = BASE1 %>% ungroup() %>%
  group_by(covid_wave) %>%
  summarise(across(c(price, hubling, aircraft, flight_hours, take_off, RouteShare, tx_seat, 
         free_luggage, paid_luggage, `0-5`, `6-11`, `12-17`, `18-23`, DepHUB,          
         capital_dep, ArrHUB, capital_arr), ~ sd(.x, na.rm = TRUE))) %>%
  mutate(covid_wave = case_when(covid_wave == "normal" ~ 2,
                                covid_wave == "first" ~ 4,
                                covid_wave == "second" ~ 6, TRUE ~ 0))

# merging mean and sd databases
sdfull = sdfulla %>%
  bind_rows(sdfullb) %>%
  arrange(covid_wave) %>%
  mutate(across(c(price, hubling, aircraft, flight_hours, take_off, RouteShare, tx_seat, 
         free_luggage, paid_luggage, `0-5`, `6-11`, `12-17`, `18-23`, DepHUB,          
         capital_dep, ArrHUB, capital_arr), ~ round(.x, 2))) %>%
  mutate(covid_wave = case_when(covid_wave == 1 ~ "normal_mean",
                                covid_wave == 2 ~ "normal_sd",
                                covid_wave == 3 ~ "first_mean",
                                covid_wave == 4 ~ "first_sd",
                                covid_wave == 5 ~ "second_mean",
                                covid_wave == 6 ~ "second_sd", TRUE ~ "erro")) %>%
  gather(variable,value,price:capital_arr) %>%
  spread(covid_wave,value) %>%
  select(variable, normal_mean, normal_sd, first_mean, first_sd, second_mean, second_sd)
  
print(sdfull)

```

```{r sd_full_duopoly, include=FALSE, echo=FALSE}

# applying mean operation
sdfulla = BASE1 %>% ungroup() %>%
  filter(N == 2) %>%
  group_by(covid_wave, market) %>%
  summarise(across(c(price, hubling, aircraft, flight_hours, take_off, RouteShare, tx_seat, 
         free_luggage, paid_luggage, `0-5`, `6-11`, `12-17`, `18-23`, DepHUB,          
         capital_dep, ArrHUB, capital_arr), ~ mean(.x, na.rm = TRUE))) %>%
  mutate(covid_wave = case_when(covid_wave == "normal" ~ 1,
                                covid_wave == "first" ~ 3,
                                covid_wave == "second" ~ 5, TRUE ~ 0))


# applying mean operation
sdfulla = BASE1 %>% ungroup() %>%
  filter(N == 2) %>%
  select(year, month, air_dep, air_arr, market, covid_wave,
         price, hubling, aircraft, flight_hours, take_off, RouteShare, tx_seat, 
         free_luggage, paid_luggage, `0-5`, `6-11`, `12-17`, `18-23`) %>%
  gather(variable, value, price:`18-23`) %>%
  arrange(variable, market) %>% 
  group_by(year, month, air_dep, air_arr, market, variable) %>%
  mutate(id = sequence(n())) %>%
  group_by(variable) %>%
  spread(market, value) %>%
  filter(variable == "price") %>%
  group_by(year, month, covid_wave) %>%
  dplyr::summarise(meanl = mean(lider),
                   means = mean(seguidora)) %>%
  mutate(diff = meanl - means)

```

```{r databases, warning=FALSE, message=FALSE, error=FALSE, include=TRUE, echo = FALSE}

{
# organizing database
dLBASE1 = LBASE1 %>% 
  ungroup() %>%
  arrange(year, month, air_dep, air_arr, airline) %>%
  group_by(year, month) %>% 
  mutate(id = sequence(n()),
         time = paste0(year,"/", month))

# creating group indices' variable
dLBASE1$group = dLBASE1 %>% group_indices(time)

# transforming to panel data
dLBASE1 = pdata.frame(dLBASE1, index = c("id","time")) %>%
  ungroup() %>% arrange(year, month)

} # organizing LBASE1

{
# organizing database
dLBASE1c = LBASE1c %>% 
  ungroup() %>%
  arrange(year, month, air_dep, air_arr, airline) %>%
  group_by(year, month) %>% 
  mutate(id = sequence(n()),
         time = paste0(year,"/", month))

# creating group indices' variable
dLBASE1c$group = dLBASE1c %>% group_indices(time)

# transforming to panel data
dLBASE1c = pdata.frame(dLBASE1c, index = c("id","time")) %>%
  ungroup() %>% arrange(year, month)

} # organizing LBASE1c

{
# organizing database
dLBASE2 = LBASE2 %>% 
  ungroup() %>%
  arrange(year, month, air_dep, air_arr) %>%
  group_by(year, month) %>% 
  mutate(id = sequence(n()),
         time = paste0(year,"/", month))

# creating group indices' variable
dLBASE2$group = dLBASE2 %>% group_indices(time)

# transforming to panel data
dLBASE2 = pdata.frame(dLBASE2, index = c("id","time")) %>%
  ungroup() %>% arrange(year, month)

} # organizing LBASE2

{
# organizing database
dLBASE2c = LBASE2c %>% 
  ungroup() %>%
  arrange(year, month, air_dep, air_arr) %>%
  group_by(year, month) %>% 
  mutate(id = sequence(n()),
         time = paste0(year,"/", month))

# creating group indices' variable
dLBASE2c$group = dLBASE2c %>% group_indices(time)

# transforming to panel data
dLBASE2c = pdata.frame(dLBASE2c, index = c("id","time")) %>%
  ungroup() %>% arrange(year, month)

} # organizing LBASE2c


```

```{r base1, include = FALSE, echo = FALSE}

# dummies | Tourist | N | market | covid | covid_wave | quarter | airline
# arrival dummies | ArrHUB | market_arr | region_arr | capital_arr 
# departure dummies | DepHUB | market_dep | capital_dep | region_dep

# defining equations
OLS = price ~  hubling + aircraft + flight_hours +  
  connection + X6.11 + X12.17 + X18.23 + RouteShare + factor(Tourist) + factor(N)  + 
  factor(covid) + factor(covid_wave) + factor(quarter) + factor(ArrHUB) + factor(market_arr) +
  factor(capital_arr)

IV = price ~ hubling + aircraft + flight_hours +  
  connection + X6.11 + X12.17 + X18.23 + RouteShare + factor(Tourist) + factor(N) +  
  factor(covid) + factor(covid_wave) + factor(quarter) + factor(ArrHUB) + factor(market_arr) +
  factor(capital_arr) | . -RouteShare + m150RouteShare

GMM = price ~ lag(price) + hubling + aircraft + flight_hours +  
  connection + X6.11 + X12.17 + X18.23 + RouteShare | lag(RouteShare, 1:10) + lag(price, 2:10) + m150RouteShare 

# regression
ols = plm(OLS, data = dLBASE1, model = "pooling")
fe =  plm(OLS, data = dLBASE1, effect = "individual")
ivfe = update(fe, IV)

# ec2sls
ecw1 = plm(IV, data = dLBASE1, model = "within")
ecr1 = update(ecw1, model = "random", random.method = "nerlove", inst.method = "baltagi")

# Hausman test
#phtest(ecw1, ecr1) # H1: one model is inconsistent - p_valor < 0,10 : within

# ht2sls

# ec
ht1r = plm(IV, data = dLBASE1, model = "random", 
           inst.method = "baltagi", random.method = "ht")
# w
ht1w = plm(IV, data = dLBASE1, model = "within", 
           inst.method = "baltagi", random.method = "ht")

# Hausman test
#phtest(ht1w, ht1r)

# gmm  
gmm = pgmm(GMM, dLBASE1, model = "onestep", effect="individual")

# joining regression results
screenreg(list(ols = ols, fe = fe, ivfe = ivfe, ecw1 = ecw1, ht1r = ht1r, gmm = gmm),
               digits = 3, omit.coef = "(Intercept)")

```



